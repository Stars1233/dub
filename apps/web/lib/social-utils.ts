import { PlatformType } from "@dub/prisma/client";
import { getUrlFromStringIfValid } from "@dub/utils";

interface SocialPlatformConfig {
  patterns: RegExp[];
  allowedChars: RegExp;
  allowedDomains: string[];
  maxLength?: number;
  name: string;
}

export const SOCIAL_PLATFORM_CONFIGS: Record<
  Exclude<PlatformType, "website">,
  SocialPlatformConfig
> = {
  youtube: {
    patterns: [
      /^(?:.*\.)?(?:youtube\.com|youtu\.be)\/(?:channel\/|c\/|user\/|@)?([^\/\?]+)/i,
      /^@([^\/\?]+)/i,
    ],
    allowedChars: /[^\w.-]/g,
    allowedDomains: ["youtube.com", "youtu.be"],
    maxLength: 30,
    name: "YouTube",
  },
  twitter: {
    patterns: [
      /^(?:.*\.)?(?:twitter\.com|x\.com)\/([^\/\?]+)/i,
      /^@([^\/\?]+)/i,
    ],
    allowedChars: /[^\w]/g,
    allowedDomains: ["twitter.com", "x.com"],
    maxLength: 15,
    name: "X/Twitter",
  },
  linkedin: {
    patterns: [/^(?:.*\.)?linkedin\.com\/(?:in\/)?([^\/\?]+)/i],
    allowedChars: /[^\w-]/g,
    allowedDomains: ["linkedin.com"],
    maxLength: 30,
    name: "LinkedIn",
  },
  instagram: {
    patterns: [/^(?:.*\.)?instagram\.com\/([^\/\?]+)/i, /^@([^\/\?]+)/i],
    allowedChars: /[^\w.]/g,
    allowedDomains: ["instagram.com"],
    maxLength: 30,
    name: "Instagram",
  },
  tiktok: {
    patterns: [/^(?:.*\.)?tiktok\.com\/(?:@)?([^\/\?]+)/i, /^@([^\/\?]+)/i],
    allowedChars: /[^\w.]/g,
    allowedDomains: ["tiktok.com"],
    maxLength: 24,
    name: "TikTok",
  },
};

export const sanitizeWebsite = (input: string | null | undefined) => {
  if (!input || typeof input !== "string") return null;

  let website = input.trim();
  if (!website) return null;
  if (!website.includes(".") || website.includes(" ")) return null;

  return getUrlFromStringIfValid(website);
};

export const sanitizeSocialHandle = (
  input: string | null | undefined,
  platform: PlatformType,
) => {
  if (!input || typeof input !== "string") {
    return null;
  }

  let handle = input.trim();
  if (!handle) {
    return null;
  }

  handle = handle
    .replace(/^https?:\/\//i, "")
    .replace(/^https?$/i, "") // standalone "http" or "https"
    .replace(/^www\./i, "") // www. prefix
    .replace(/\?.*$/, "") // query params (e.g. ?s=21&t=...)
    .replace(/#.*$/, ""); // hash/fragment (e.g. #section)

  const { patterns, allowedChars, allowedDomains, maxLength } =
    SOCIAL_PLATFORM_CONFIGS[platform];

  if (!allowedDomains.some((domain) => handle.toLowerCase().includes(domain))) {
    return null;
  }

  for (const pattern of patterns) {
    const match = handle.match(pattern);

    if (match) {
      handle = match[1];
      break;
    }
  }

  handle = handle.replace(/\/.*$/, "").replace(allowedChars, "");

  if (maxLength) {
    handle = handle.substring(0, maxLength);
  }

  return handle || null;
};

// Converts an array of platform objects into a key-value object
// for easy lookup by platform name. Returns null for platforms not found.
export function buildSocialPlatformLookup<T extends { type: PlatformType }>(
  platforms: T[],
): Record<PlatformType, T | null> {
  const result = {
    website: null,
    youtube: null,
    twitter: null,
    linkedin: null,
    instagram: null,
    tiktok: null,
  } as Record<PlatformType, T | null>;

  for (const platform of platforms) {
    result[platform.type] = platform;
  }

  return result;
}

// Polyfills social media fields from platforms array for backward compatibility
export function polyfillSocialMediaFields<
  T extends { type: PlatformType; identifier: string | null },
>(platforms: T[]) {
  const platformsMap = buildSocialPlatformLookup(platforms);

  return {
    website: platformsMap["website"]?.identifier ?? null,
    youtube: platformsMap["youtube"]?.identifier ?? null,
    twitter: platformsMap["twitter"]?.identifier ?? null,
    linkedin: platformsMap["linkedin"]?.identifier ?? null,
    instagram: platformsMap["instagram"]?.identifier ?? null,
    tiktok: platformsMap["tiktok"]?.identifier ?? null,
  };
}
